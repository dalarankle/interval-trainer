<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>間歇訓練計時器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        :root {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app {
            width: 100%;
            max-width: 480px;
            padding: 16px;
            box-sizing: border-box;
        }
        h1 {
            font-size: 1.4rem;
            text-align: center;
            margin: 0 0 12px;
        }
        .settings {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 8px 10px;
            background: #111827;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            margin-bottom: 14px;
        }
        .settings label {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }
        .settings input {
            width: 100%;
            padding: 6px 8px;
            font-size: 0.95rem;
            border-radius: 10px;
            border: 1px solid #374151;
            background: #020617;
            color: #f9fafb;
            box-sizing: border-box;
        }
        .settings input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 1px #60a5fa55;
        }
        .display-card {
            background: linear-gradient(135deg, #1d4ed8, #4f46e5);
            border-radius: 24px;
            padding: 18px 18px 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(15,23,42,0.9);
            margin-bottom: 12px;
        }
        .phase {
            font-size: 1.1rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            opacity: 0.9;
        }
        .time {
            font-size: 3rem;
            font-weight: 700;
            margin: 6px 0 2px;
        }
        .round {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .buttons button {
            flex: 1;
            padding: 10px 12px;
            font-size: 1rem;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        #startBtn {
            background: #22c55e;
            color: #022c22;
        }
        #pauseBtn {
            background: #facc15;
            color: #422006;
        }
        #resetBtn {
            background: #ef4444;
            color: #fef2f2;
        }
        #startBtn:active,
        #pauseBtn:active,
        #resetBtn:active {
            transform: translateY(1px);
        }
        .hint {
            font-size: 0.75rem;
            opacity: 0.8;
            text-align: center;
            line-height: 1.4;
        }
        .hint span {
            opacity: 1;
        }
        @media (max-width: 400px) {
            .time {
                font-size: 2.6rem;
            }
            .settings {
                grid-template-columns: 1.3fr 1fr;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <h1>間歇訓練計時器</h1>

    <div class="display-card">
        <div id="statusText" class="phase">尚未開始</div>
        <div id="timeDisplay" class="time">00:00</div>
        <div id="roundDisplay" class="round">— / —</div>
    </div>

    <div class="settings">
        <label for="warmup">暖身秒數</label>
        <input id="warmup" data-setting type="number" min="0" inputmode="numeric" placeholder="例如 60">

        <label for="work">訓練秒數 *</label>
        <input id="work" data-setting type="number" min="1" inputmode="numeric" placeholder="例如 30">

        <label for="rest">休息秒數</label>
        <input id="rest" data-setting type="number" min="0" inputmode="numeric" placeholder="例如 15">

        <label for="rounds">組數 *</label>
        <input id="rounds" data-setting type="number" min="1" inputmode="numeric" placeholder="例如 8">

        <label for="cooldown">放鬆秒數</label>
        <input id="cooldown" data-setting type="number" min="0" inputmode="numeric" placeholder="例如 60">
    </div>

    <div class="buttons">
        <button id="startBtn">開始</button>
        <button id="pauseBtn">暫停</button>
        <button id="resetBtn">重設</button>
    </div>

    <div class="hint">
        <span>提示：</span>第一次按「開始」時請把 iPhone 鈴聲打開，<br>
        之後切換階段會有短提示音。
    </div>
</div>

<script>
(function () {
    // 狀態變數
    let timerId = null;
    let running = false;
    let phase = ""; // "warmup" | "work" | "rest" | "cooldown" | "done"
    let remaining = 0;

    let warmupSec = 0;
    let workSec = 0;
    let restSec = 0;
    let cooldownSec = 0;
    let totalRounds = 1;
    let currentRound = 1;

    const statusText = document.getElementById("statusText");
    const timeDisplay = document.getElementById("timeDisplay");
    const roundDisplay = document.getElementById("roundDisplay");

    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resetBtn = document.getElementById("resetBtn");

    const settingInputs = document.querySelectorAll("[data-setting]");

    // --- 儲存 / 載入設定（用 localStorage） ---
    function saveSettings() {
        const data = {};
        settingInputs.forEach(inp => {
            data[inp.id] = inp.value;
        });
        try {
            localStorage.setItem("intervalTrainerSettings", JSON.stringify(data));
        } catch (e) {
            // 忽略儲存錯誤
        }
    }

    function loadSettings() {
        try {
            const raw = localStorage.getItem("intervalTrainerSettings");
            if (!raw) return;
            const data = JSON.parse(raw);
            settingInputs.forEach(inp => {
                if (data[inp.id] != null) {
                    inp.value = data[inp.id];
                }
            });
        } catch (e) {
            // 忽略載入錯誤
        }
    }

    settingInputs.forEach(inp => {
        inp.addEventListener("input", saveSettings);
    });

    // --- 聲音（簡單 Beep，無需音檔） ---
    function playBeep(duration = 200, frequency = 700, volume = 0.2) {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;

        if (!playBeep.ctx) {
            playBeep.ctx = new AudioCtx();
        }
        const ctx = playBeep.ctx;

        if (ctx.state === "suspended") {
            ctx.resume();
        }

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = frequency;
        gain.gain.value = volume;

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.start();
        setTimeout(() => {
            osc.stop();
        }, duration);
    }

    // --- 工具函式 ---
    function parseSeconds(id, defaultValue = 0) {
        const el = document.getElementById(id);
        const v = parseInt(el.value, 10);
        if (isNaN(v) || v < 0) return defaultValue;
        return v;
    }

    function formatTime(sec) {
        sec = Math.max(0, sec | 0);
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    function phaseLabel(p) {
        switch (p) {
            case "warmup": return "暖身";
            case "work": return "訓練";
            case "rest": return "休息";
            case "cooldown": return "放鬆";
            case "done": return "完成";
            default: return "尚未開始";
        }
    }

    function updateDisplay() {
        statusText.textContent = phaseLabel(phase);
        timeDisplay.textContent = remaining > 0 ? formatTime(remaining) : "00:00";
        if (phase && phase !== "done") {
            roundDisplay.textContent = currentRound + " / " + totalRounds;
        } else {
            roundDisplay.textContent = "— / —";
        }
    }

    // --- 初始化訓練設定 ---
    function initFromInputs() {
        warmupSec = parseSeconds("warmup", 0);
        workSec = parseSeconds("work", 0);
        restSec = parseSeconds("rest", 0);
        cooldownSec = parseSeconds("cooldown", 0);

        totalRounds = parseSeconds("rounds", 1);
        if (totalRounds <= 0) totalRounds = 1;

        if (workSec <= 0) {
            alert("請至少設定「訓練秒數」大於 0！");
            return false;
        }

        currentRound = 1;

        if (warmupSec > 0) {
            phase = "warmup";
            remaining = warmupSec;
        } else {
            phase = "work";
            remaining = workSec;
        }

        updateDisplay();
        saveSettings();
        return true;
    }

    // --- 切換階段 ---
    function nextPhase() {
        if (phase === "warmup") {
            // 暖身 -> 第一個訓練階段
            phase = "work";
            remaining = workSec;
            playBeep();
        } else if (phase === "work") {
            if (currentRound < totalRounds) {
                // 還有下一組
                if (restSec > 0) {
                    phase = "rest";
                    remaining = restSec;
                    playBeep();
                } else {
                    currentRound++;
                    phase = "work";
                    remaining = workSec;
                    playBeep();
                }
            } else {
                // 最後一組訓練做完
                if (cooldownSec > 0 && phase !== "cooldown") {
                    phase = "cooldown";
                    remaining = cooldownSec;
                    playBeep();
                } else {
                    finishWorkout();
                }
            }
        } else if (phase === "rest") {
            // 休息 -> 下一組訓練 或 結束
            currentRound++;
            if (currentRound <= totalRounds) {
                phase = "work";
                remaining = workSec;
                playBeep();
            } else {
                if (cooldownSec > 0) {
                    phase = "cooldown";
                    remaining = cooldownSec;
                    playBeep();
                } else {
                    finishWorkout();
                }
            }
        } else if (phase === "cooldown") {
            finishWorkout();
        }
    }

    function finishWorkout() {
        running = false;
        if (timerId) clearInterval(timerId);
        timerId = null;
        phase = "done";
        remaining = 0;
        updateDisplay();
        // 完成用長一點的 Beep
        playBeep(400, 440, 0.3);
    }

    // --- 計時器 Tick ---
    function tick() {
        if (!running) return;
        remaining--;
        if (remaining <= 0) {
            nextPhase();
        }
        updateDisplay();
    }

    // --- 控制按鈕 ---
    function startTimer() {
        if (running) return;

        // 初始化階段
        if (!phase) {
            const ok = initFromInputs();
            if (!ok) return;
        }

        // 確保只有一個 interval
        if (timerId) clearInterval(timerId);
        running = true;
        timerId = setInterval(tick, 1000);
        playBeep(120, 900, 0.15); // 開始提示音
    }

    function pauseTimer() {
        if (!running) return;
        running = false;
        if (timerId) clearInterval(timerId);
        timerId = null;
    }

    function resetTimer() {
        running = false;
        if (timerId) clearInterval(timerId);
        timerId = null;
        phase = "";
        remaining = 0;
        currentRound = 1;
        updateDisplay();
    }

    startBtn.addEventListener("click", startTimer);
    pauseBtn.addEventListener("click", pauseTimer);
    resetBtn.addEventListener("click", resetTimer);

    // 初始顯示與載入設定
    loadSettings();
    updateDisplay();
})();
</script>
</body>
</html>
